<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>å¯å‚åŠ è€ƒè¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen p-6">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <a href="{{ url_for('dashboard.dashboard') }}" class="text-blue-600 hover:underline font-medium text-lg">
                â† è¿”å›æ§åˆ¶å°
            </a>
        </div>
        <form action="{{ url_for('logout') }}" method="post">
            <button type="submit" class="text-red-600 hover:underline font-medium text-lg">
                æ³¨é”€å¹¶è¿”å›ç™»å½•
            </button>
        </form>
    </div>

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">ğŸ“ å¯å‚åŠ è€ƒè¯•</h1>

        <!-- è€ƒè¯•åˆ—è¡¨ -->
        <div id="exam-list" class="space-y-4">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="empty-state" class="hidden text-center py-12">
            <div class="text-gray-400 text-6xl mb-4">ğŸ“‹</div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">æš‚æ— å¯å‚åŠ çš„è€ƒè¯•</h3>
            <p class="text-gray-500">è¯·ç­‰å¾…æ•™å¸ˆå‘å¸ƒæ–°çš„è€ƒè¯•</p>
        </div>
    </div>

    <script>
        async function loadAvailableExams() {
            try {
                const response = await fetch('/student/api/available_exams');
                const data = await response.json();
                
                const container = document.getElementById('exam-list');
                const emptyState = document.getElementById('empty-state');
                
                container.innerHTML = '';
                
                if (data.success && data.exams && data.exams.length > 0) {
                    emptyState.classList.add('hidden');
                    
                    data.exams.forEach(exam => {
                        const examCard = document.createElement('div');
                        examCard.className = 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition';
                        
                        const startTime = new Date(exam.start_time);
                        const endTime = new Date(exam.end_time);
                        const now = new Date();
                        
                        let statusClass = 'bg-green-100 text-green-800';
                        let statusText = 'å¯å‚åŠ ';
                        let canTakeExam = true;
                        
                        if (now < startTime) {
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            statusText = 'æœªå¼€å§‹';
                            canTakeExam = false;
                        } else if (now > endTime) {
                            statusClass = 'bg-red-100 text-red-800';
                            statusText = 'å·²ç»“æŸ';
                            canTakeExam = false;
                        }
                        
                        examCard.innerHTML = `
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold text-gray-900 mb-2">${exam.exam_title}</h3>
                                    <p class="text-gray-600 mb-3">${exam.description || 'æš‚æ— æè¿°'}</p>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                                        <div>
                                            <strong>å¼€å§‹æ—¶é—´:</strong> ${startTime.toLocaleString()}
                                        </div>
                                        <div>
                                            <strong>ç»“æŸæ—¶é—´:</strong> ${endTime.toLocaleString()}
                                        </div>
                                        <div>
                                            <strong>å·²å‚åŠ æ¬¡æ•°:</strong> ${exam.current_attempts || 0}/${exam.max_attempts}
                                        </div>
                                        <div>
                                            <strong>è€ƒè¯•æ ‡è¯†:</strong> ${exam.identifier}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex flex-col items-end space-y-2">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${statusText}
                                    </span>
                                    ${canTakeExam ? `
                                        <button onclick="takeExam('${exam.identifier}')" 
                                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                            å‚åŠ è€ƒè¯•
                                        </button>
                                    ` : `
                                        <button disabled class="bg-gray-300 text-gray-500 px-4 py-2 rounded-lg cursor-not-allowed">
                                            ${statusText}
                                        </button>
                                    `}
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(examCard);
                    });
                } else {
                    emptyState.classList.remove('hidden');
                }
            } catch (error) {
                console.error('åŠ è½½è€ƒè¯•åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('exam-list').innerHTML = 
                    '<div class="text-red-500 text-center py-8">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            }
        }

        function takeExam(identifier) {
            if (confirm('ç¡®å®šè¦å‚åŠ è¿™åœºè€ƒè¯•å—ï¼Ÿä¸€æ—¦å¼€å§‹è€ƒè¯•ï¼Œæ‚¨çš„å‚åŠ æ¬¡æ•°å°†ä¼šå¢åŠ ã€‚')) {
                window.open(`/exam/${identifier}`, '_blank');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadAvailableExams);
        
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
        setInterval(loadAvailableExams, 30000);
    </script>
</body>

</html>
