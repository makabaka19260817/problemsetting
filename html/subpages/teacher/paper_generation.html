<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>ç»„å·ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6 font-sans">
    <!-- ğŸ” é¡¶éƒ¨å¯¼èˆª -->
    <div class="flex justify-between items-center mb-6">
        <a href="{{ url_for('dashboard.dashboard') }}" class="text-blue-600 hover:underline font-medium">
            â† è¿”å›ç®¡ç†é¢æ¿
        </a>
        <form action="{{ url_for('logout') }}" method="post">
            <button type="submit" class="text-red-600 hover:underline font-medium">
                æ³¨é”€å¹¶è¿”å›ç™»å½•
            </button>
        </form>
    </div>

    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“„ ç»„å·ç®¡ç†</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- æ‰€æœ‰é¢˜ç›® -->
        <div class="bg-white p-4 rounded-xl shadow-md">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“š é¢˜åº“</h2>
            <ul id="question-list" class="space-y-3"></ul>
        </div>

        <!-- å½“å‰å·å­ -->
        <div class="bg-white p-4 rounded-xl shadow-md">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“ å½“å‰è¯•å·</h2>
            <ul id="paper-list" class="space-y-3 border rounded-md p-3 min-h-[200px] bg-gray-50"></ul>
            <input id="paper-title" class="mt-4 w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥è¯•å·æ ‡é¢˜..." />
            <button onclick="savePaper()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-md transition">
                ğŸ’¾ å®Œæˆç»„å·
            </button>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-[90%] md:w-1/2 max-w-2xl">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">é¢˜ç›®ä¿¡æ¯</h2>
            <pre id="modal-content" class="bg-gray-100 rounded p-4 text-gray-700 whitespace-pre-wrap text-sm"></pre>
            <button onclick="closeModal()" class="mt-6 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded transition">
                å…³é—­
            </button>
        </div>
    </div>


    <script>
        let allQuestions = [];

        function renderQType(qtype) {
            switch (qtype) {
                case 'single_choice':
                    return 'é€‰æ‹©é¢˜ - å•é€‰';
                case 'multiple_choice':
                    return 'é€‰æ‹©é¢˜ - å¤šé€‰';
                case 'true_false':
                    return 'åˆ¤æ–­é¢˜';
                case 'essay':
                    return 'é—®ç­”é¢˜';
                default:
                    return qtype;
            }
        }

        async function loadQuestions() {
            const res = await fetch('/teacher/questions/all');
            allQuestions = await res.json();
            const list = document.getElementById('question-list');
            list.innerHTML = '';
            for (const q of allQuestions) {
                const li = document.createElement('li');
                li.className = 'p-2 border rounded bg-white flex justify-between items-center';
                li.dataset.qid = q.id;
                li.textContent = `[${renderQType(q.qtype)}] ${q.content.slice(0, 20)}... éš¾åº¦: ${q.difficulty}`;

                const btnContainer = document.createElement('div');

                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯';
                viewBtn.className = 'ml-2 text-blue-600 hover:underline';
                viewBtn.onclick = () => showModal(q);
                btnContainer.appendChild(viewBtn);

                const addBtn = document.createElement('button');
                addBtn.textContent = 'åŠ å…¥';
                addBtn.className = 'ml-2 text-green-600 hover:underline';
                addBtn.onclick = () => addToPaper(q);
                btnContainer.appendChild(addBtn);

                li.appendChild(btnContainer);
                list.appendChild(li);
            }
        }

        function addToPaper(q) {
            // å¦‚æœé¢˜ç›®å·²åœ¨è¯•å·ä¸­ï¼Œä¸å†æ·»åŠ 
            if (document.querySelector(`#paper-list li[data-qid="${q.id}"]`)) {
                return;
            }
            // ç§»é™¤é¢˜åº“ä¸­çš„å¯¹åº”é¡¹
            const questionList = document.getElementById('question-list');
            const allLis = Array.from(questionList.children);
            let removedLi = null;
            for (const li of allLis) {
                if (li.textContent.includes(q.content.slice(0, 20))) {
                    removedLi = li;
                    li.remove();
                    break;
                }
            }

            const li = document.createElement('li');
            li.className = 'p-2 border rounded bg-white flex justify-between items-center';
            li.dataset.qid = q.id;

            const contentSpan = document.createElement('span');
            contentSpan.textContent = `[${renderQType(q.qtype)}] ${q.content.slice(0, 20)}... éš¾åº¦: ${q.difficulty}`;
            li.appendChild(contentSpan);

            const btnContainer = document.createElement('div');
            btnContainer.className = 'flex items-center';

            const scoreInput = document.createElement('input');
            scoreInput.type = 'number';
            scoreInput.min = '1';
            scoreInput.value = '5';
            scoreInput.title = 'åˆ†æ•°';
            scoreInput.className = 'ml-2 w-20 border rounded px-1 py-0.5 text-sm text-center';
            btnContainer.appendChild(scoreInput);

            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'æŸ¥çœ‹';
            viewBtn.className = 'ml-2 text-blue-600 hover:underline text-sm';
            viewBtn.onclick = () => showModal(q);
            btnContainer.appendChild(viewBtn);

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'ç§»é™¤';
            removeBtn.className = 'ml-2 text-red-600 hover:underline text-sm';
            removeBtn.onclick = () => {
                li.remove();
                if (removedLi) {
                    questionList.appendChild(removedLi); // æ¢å¤é¢˜åº“é¡¹
                }
            };
            btnContainer.appendChild(removeBtn);

            li.appendChild(btnContainer);
            document.getElementById('paper-list').appendChild(li);
        }



        async function savePaper() {
            const title = document.getElementById('paper-title').value;

            const questions = Array.from(document.querySelectorAll('#paper-list > li')).map(li => {
                const qid = li.dataset.qid;
                const score = li.querySelector('input[type="number"]').value;
                return {
                    id: qid,
                    score: parseInt(score) || 0
                };
            });

            const res = await fetch('/teacher/paper', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title,
                    questions
                })
            });

            const result = await res.json();
            alert(result.success ? 'ä¿å­˜æˆåŠŸ' : 'ä¿å­˜å¤±è´¥');
        }


        function showModal(question) {
            document.getElementById('modal-content').textContent =
                `ç±»å‹: ${renderQType(question.qtype)}\nå†…å®¹: ${question.content}\néš¾åº¦: ${question.difficulty}`;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        window.onload = () => {
            loadQuestions();
            Sortable.create(document.getElementById('paper-list'), {
                animation: 150
            });
        }
    </script>
</body>

</html>