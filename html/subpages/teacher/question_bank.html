<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>é¢˜åº“ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="p-6 bg-gray-50">
    <!-- ğŸ” é¡¶éƒ¨å¯¼èˆª -->
    <div class="flex justify-between items-center mb-6">
        <div class="space-x-4">
            <a href="{{ url_for('dashboard.dashboard') }}" class="text-blue-600 hover:underline font-medium">è¿”å›ç®¡ç†é¢æ¿</a>
        </div>
        <form action="{{ url_for('logout') }}" method="post">
            <button type="submit" class="text-red-600 hover:underline font-medium">æ³¨é”€å¹¶è¿”å›ç™»å½•</button>
        </form>
    </div>

    <h2 class="text-2xl font-bold mb-4">é¢˜åº“ç®¡ç†</h2>

    <button id="btnAddQuestion" class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">æ·»åŠ é¢˜ç›®</button>

    <table class="min-w-full bg-white rounded shadow overflow-hidden">
        <thead class="bg-gray-100 border-b">
            <tr>
                <th class="text-left p-3">ç±»å‹</th>
                <th class="text-left p-3">é¢˜é¢</th>
                <th class="text-left p-3">éš¾æ˜“åº¦</th>
                <th class="text-left p-3">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="questionTableBody" class="divide-y"></tbody>
    </table>

    <div class="mt-4 flex justify-center space-x-2" id="pagination"></div>

    <!-- å¼¹çª—é®ç½© -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-40 hidden"></div>

    <!-- é¢˜ç›®å¼¹çª— -->
    <div id="questionModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded shadow-lg p-6 w-11/12 max-w-2xl hidden z-50">
        <h3 class="text-xl font-semibold mb-4" id="modalTitle">æŸ¥çœ‹ / ç¼–è¾‘é¢˜ç›®</h3>
        <form id="questionForm" class="space-y-4">
            <input type="hidden" id="questionId" />
            <div>
                <label for="qtype" class="block font-medium mb-1">ç±»å‹</label>
                <select id="qtype" class="w-full border rounded px-3 py-2" required>
        <option value="single_choice">é€‰æ‹©é¢˜ï¼ˆå•é€‰ï¼‰</option>
        <option value="multiple_choice">é€‰æ‹©é¢˜ï¼ˆå¤šé€‰ï¼‰</option>
        <option value="true_false">åˆ¤æ–­é¢˜</option>
        <option value="essay">é—®ç­”é¢˜</option>
      </select>
            </div>
            <div>
                <label for="content" class="block font-medium mb-1">é¢˜é¢</label>
                <textarea id="content" class="w-full border rounded px-3 py-2" rows="3" required></textarea>
            </div>
            <div>
                <label for="difficulty" class="block font-medium mb-1">éš¾æ˜“åº¦ï¼ˆ1-5ï¼‰</label>
                <input type="number" id="difficulty" class="w-full border rounded px-3 py-2" min="1" max="5" required />
            </div>
            <div>
                <label for="answer" class="block font-medium mb-1">ç­”æ¡ˆï¼ˆJSONæˆ–æ–‡æœ¬ï¼‰</label>
                <textarea id="answer" class="w-full border rounded px-3 py-2" rows="3" required></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ä¿å­˜</button>
                <button type="button" id="btnCloseModal" class="px-4 py-2 bg-gray-400 rounded hover:bg-gray-500">å…³é—­</button>
            </div>
        </form>
    </div>

    <script>
        let currentPage = 1,
            totalPages = 1;

        function renderQType(qtype) {
            switch (qtype) {
                case 'single_choice':
                    return 'é€‰æ‹©é¢˜ï¼ˆå•é€‰ï¼‰';
                case 'multiple_choice':
                    return 'é€‰æ‹©é¢˜ï¼ˆå¤šé€‰ï¼‰';
                case 'true_false':
                    return 'åˆ¤æ–­é¢˜';
                case 'essay':
                    return 'é—®ç­”é¢˜';
                default:
                    return qtype;
            }
        }

        function showModal() {
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('questionModal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            document.getElementById('questionModal').classList.add('hidden');
        }

        function loadQuestions(page = 1) {
            axios.get(`/teacher/questions?page=${page}`)
                .then(res => {
                    const data = res.data;
                    totalPages = data.total_pages;
                    currentPage = data.current_page;
                    const tbody = document.getElementById('questionTableBody');
                    tbody.innerHTML = '';
                    data.questions.forEach(q => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-100';
                        tr.innerHTML = `
            <td class="p-3">${renderQType(q.qtype)}</td>
            <td class="p-3 max-w-xs truncate" title="${q.content}">${q.content}</td>
            <td class="p-3">${q.difficulty}</td>
            <td class="p-3 space-x-2">
              <button class="text-blue-600 hover:underline btn-view" data-id="${q.id}">æŸ¥çœ‹è¯¦æƒ…</button>
              <button class="text-yellow-600 hover:underline btn-edit" data-id="${q.id}">ç¼–è¾‘</button>
              <button class="text-red-600 hover:underline btn-delete" data-id="${q.id}">åˆ é™¤</button>
            </td>`;
                        tbody.appendChild(tr);
                    });
                    renderPagination();
                    bindTableButtons();
                })
                .catch(err => alert('åŠ è½½é¢˜ç›®å¤±è´¥'));
        }

        function renderPagination() {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === currentPage ?
                    'px-3 py-1 bg-blue-600 text-white rounded' :
                    'px-3 py-1 bg-gray-200 rounded hover:bg-gray-300';
                btn.addEventListener('click', () => loadQuestions(i));
                container.appendChild(btn);
            }
        }

        function bindTableButtons() {
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.dataset.id;
                    axios.get(`/teacher/question/${id}`).then(res => {
                        const q = res.data;
                        document.getElementById('modalTitle').textContent = 'æŸ¥çœ‹é¢˜ç›®';
                        fillForm(q);
                        disableForm(true);
                        showModal();
                    }).catch(() => alert('è·å–è¯¦æƒ…å¤±è´¥'));
                }
            });
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.dataset.id;
                    axios.get(`/teacher/question/${id}`).then(res => {
                        const q = res.data;
                        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é¢˜ç›®';
                        fillForm(q);
                        disableForm(false);
                        showModal();
                    }).catch(() => alert('è·å–è¯¦æƒ…å¤±è´¥'));
                }
            });
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.dataset.id;
                    if (confirm('ç¡®å®šåˆ é™¤è¯¥é¢˜ç›®å—ï¼Ÿ')) {
                        axios.delete(`/teacher/question/${id}`).then(() => {
                            alert('åˆ é™¤æˆåŠŸ');
                            loadQuestions(currentPage);
                        }).catch(() => alert('åˆ é™¤å¤±è´¥'));
                    }
                }
            });
        }

        function fillForm(q) {
            document.getElementById('questionId').value = q.id || '';
            document.getElementById('qtype').value = q.qtype || '';
            document.getElementById('content').value = q.content || '';
            document.getElementById('difficulty').value = q.difficulty || 1;
            document.getElementById('answer').value = q.answer || '';
        }

        function disableForm(disable) {
            ['qtype', 'content', 'difficulty', 'answer'].forEach(id => {
                document.getElementById(id).disabled = disable;
            });
            document.querySelector('#questionForm button[type=submit]').style.display = disable ? 'none' : 'inline-block';
        }

        document.getElementById('btnAddQuestion').onclick = () => {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ æ–°é¢˜ç›®';
            fillForm({
                qtype: 'single_choice',
                content: '',
                difficulty: 1,
                answer: ''
            });
            disableForm(false);
            document.getElementById('questionId').value = '';
            showModal();
        };

        document.getElementById('btnCloseModal').onclick = hideModal;

        document.getElementById('questionForm').onsubmit = e => {
            e.preventDefault();
            const id = document.getElementById('questionId').value;
            const payload = {
                qtype: document.getElementById('qtype').value,
                content: document.getElementById('content').value,
                difficulty: parseInt(document.getElementById('difficulty').value),
                answer: document.getElementById('answer').value,
            };
            if (id) {
                // ç¼–è¾‘
                axios.put(`/teacher/question/${id}`, payload)
                    .then(() => {
                        alert('ä¿®æ”¹æˆåŠŸ');
                        hideModal();
                        loadQuestions(currentPage);
                    }).catch(() => alert('ä¿®æ”¹å¤±è´¥'));
            } else {
                // æ–°å¢
                axios.post('/teacher/question', payload)
                    .then(() => {
                        alert('æ·»åŠ æˆåŠŸ');
                        hideModal();
                        loadQuestions(1);
                    }).catch(() => alert('æ·»åŠ å¤±è´¥'));
            }
        };

        // é¦–æ¬¡åŠ è½½
        loadQuestions();
    </script>

</body>

</html>